name: Example - Deploy Scale Set

on:
  workflow_dispatch:
    inputs:
      use_template:
        description: 'Use template file instead of parameters'
        required: true
        type: boolean
        default: false
      template_file:
        description: 'Path to template file (if use_template is true)'
        required: false
        type: string
        default: 'templates/windows-standard.yaml'
      
      # Scale Set Configuration
      runners_namespace:
        description: 'Runners namespace'
        required: true
        type: string
        default: 'runners'
      scaleset_name:
        description: 'Scale set release name'
        required: true
        type: string
        default: 'my-scale-set'
      runner_image:
        description: 'Runner container image'
        required: false
        type: string
        default: 'ghcr.io/poc-win-runners/arc-windows-runner:v2.329.0'
      
      # Infrastructure
      aws_region:
        description: 'AWS region'
        required: true
        type: string
        default: 'eu-central-1'
      cluster_name:
        description: 'EKS cluster name'
        required: true
        type: string
        default: 'arc-cluster'
      arc_systems_namespace:
        description: 'ARC controller namespace'
        required: false
        type: string
        default: 'arc-systems'
      github_secret_name:
        description: 'GitHub App secret name'
        required: false
        type: string
        default: 'gha-runner-secret'
      
      # Operation
      operation:
        description: 'Operation to perform'
        required: true
        type: choice
        options:
          - deploy
          - upgrade
          - uninstall
        default: 'deploy'

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    uses: ./.github/workflows/deploy-scaleset.yml
    with:
      template_file: ${{ inputs.use_template && inputs.template_file || '' }}
      runners_namespace: ${{ inputs.runners_namespace }}
      scaleset_name: ${{ inputs.scaleset_name }}
      runner_image: ${{ inputs.runner_image }}
      aws_region: ${{ inputs.aws_region }}
      cluster_name: ${{ inputs.cluster_name }}
      arc_systems_namespace: ${{ inputs.arc_systems_namespace }}
      github_secret_name: ${{ inputs.github_secret_name }}
      operation: ${{ inputs.operation }}
    secrets:
      ROLE_NAME: ${{ vars.ROLE_NAME }}
      AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
      GH_APP_ID: ${{ secrets.GH_APP_ID }}
      GH_INSTALLATION_ID: ${{ secrets.GH_INSTALLATION_ID }}
      GH_PRIVATE_KEY: ${{ secrets.GH_PRIVATE_KEY }}
